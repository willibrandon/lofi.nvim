{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Generation Notification Contracts",
  "description": "JSON-RPC notifications for generation progress and completion",

  "definitions": {
    "GenerationProgressNotification": {
      "type": "object",
      "description": "Sent every 5% progress during generation",
      "properties": {
        "jsonrpc": { "const": "2.0" },
        "method": { "const": "generation_progress" },
        "params": {
          "type": "object",
          "properties": {
            "track_id": {
              "type": "string",
              "pattern": "^[a-f0-9]{16}$",
              "description": "Track being generated"
            },
            "percent": {
              "type": "integer",
              "minimum": 0,
              "maximum": 99,
              "description": "Progress percentage (capped at 99 until complete)"
            },
            "tokens_generated": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of token frames generated so far"
            },
            "tokens_estimated": {
              "type": "integer",
              "minimum": 1,
              "description": "Estimated total tokens (duration_sec * 50)"
            },
            "eta_sec": {
              "type": "number",
              "minimum": 0,
              "description": "Estimated seconds remaining"
            }
          },
          "required": ["track_id", "percent", "tokens_generated", "tokens_estimated", "eta_sec"],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"]
    },

    "GenerationCompleteNotification": {
      "type": "object",
      "description": "Sent when generation finishes successfully",
      "properties": {
        "jsonrpc": { "const": "2.0" },
        "method": { "const": "generation_complete" },
        "params": {
          "type": "object",
          "properties": {
            "track_id": {
              "type": "string",
              "pattern": "^[a-f0-9]{16}$",
              "description": "Completed track identifier"
            },
            "path": {
              "type": "string",
              "description": "Absolute path to generated WAV file"
            },
            "duration_sec": {
              "type": "number",
              "minimum": 5,
              "maximum": 120,
              "description": "Actual duration of generated audio"
            },
            "sample_rate": {
              "type": "integer",
              "const": 32000,
              "description": "Audio sample rate in Hz"
            },
            "prompt": {
              "type": "string",
              "description": "Original prompt used"
            },
            "seed": {
              "type": "integer",
              "minimum": 0,
              "description": "Seed used for generation"
            },
            "generation_time_sec": {
              "type": "number",
              "minimum": 0,
              "description": "Wall-clock time for generation"
            },
            "model_version": {
              "type": "string",
              "description": "Model identifier (e.g., musicgen-small-fp16-v1)"
            }
          },
          "required": [
            "track_id", "path", "duration_sec", "sample_rate",
            "prompt", "seed", "generation_time_sec", "model_version"
          ],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"]
    },

    "GenerationErrorNotification": {
      "type": "object",
      "description": "Sent when generation fails",
      "properties": {
        "jsonrpc": { "const": "2.0" },
        "method": { "const": "generation_error" },
        "params": {
          "type": "object",
          "properties": {
            "track_id": {
              "type": "string",
              "pattern": "^[a-f0-9]{16}$",
              "description": "Track that failed"
            },
            "code": {
              "type": "string",
              "enum": [
                "MODEL_NOT_FOUND",
                "MODEL_LOAD_FAILED",
                "MODEL_DOWNLOAD_FAILED",
                "MODEL_INFERENCE_FAILED",
                "QUEUE_FULL",
                "INVALID_DURATION",
                "INVALID_PROMPT"
              ],
              "description": "Error code"
            },
            "message": {
              "type": "string",
              "description": "Human-readable error message"
            }
          },
          "required": ["track_id", "code", "message"],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"]
    },

    "DownloadProgressNotification": {
      "type": "object",
      "description": "Sent during model download",
      "properties": {
        "jsonrpc": { "const": "2.0" },
        "method": { "const": "download_progress" },
        "params": {
          "type": "object",
          "properties": {
            "file_name": {
              "type": "string",
              "description": "Current file being downloaded"
            },
            "bytes_downloaded": {
              "type": "integer",
              "minimum": 0,
              "description": "Bytes received for current file"
            },
            "bytes_total": {
              "type": "integer",
              "minimum": 0,
              "description": "Total size of current file"
            },
            "files_completed": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of files fully downloaded"
            },
            "files_total": {
              "type": "integer",
              "minimum": 1,
              "description": "Total number of files to download"
            }
          },
          "required": ["file_name", "bytes_downloaded", "bytes_total", "files_completed", "files_total"],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"]
    }
  },

  "examples": {
    "progress": {
      "jsonrpc": "2.0",
      "method": "generation_progress",
      "params": {
        "track_id": "a1b2c3d4e5f67890",
        "percent": 45,
        "tokens_generated": 675,
        "tokens_estimated": 1500,
        "eta_sec": 35.2
      }
    },
    "complete": {
      "jsonrpc": "2.0",
      "method": "generation_complete",
      "params": {
        "track_id": "a1b2c3d4e5f67890",
        "path": "/Users/user/.cache/nvim/lofi/a1b2c3d4e5f67890.wav",
        "duration_sec": 30.2,
        "sample_rate": 32000,
        "prompt": "lofi hip hop, jazzy piano",
        "seed": 1234567890,
        "generation_time_sec": 72.5,
        "model_version": "musicgen-small-fp16-v1"
      }
    },
    "error": {
      "jsonrpc": "2.0",
      "method": "generation_error",
      "params": {
        "track_id": "a1b2c3d4e5f67890",
        "code": "MODEL_INFERENCE_FAILED",
        "message": "Out of memory during token generation"
      }
    }
  }
}
